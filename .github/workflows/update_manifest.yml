name: Update Blog Manifest

on:
  issues:
    types: [opened, edited, deleted, labeled, unlabeled, reopened]
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch Issues and Generate Manifest
        shell: bash
        run: |
          # 替换为你的用户名和仓库名
          REPO="JunLoye/junloye.github.io"
          
          # 获取所有开启的 Issue（过滤掉 PR 和带有 [FEEDBACK] 的内容）
          # 注意：这里使用了 GitHub 自带的 GITHUB_TOKEN，不会消耗你的个人配额
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/issues?state=open&sort=created&direction=desc&per_page=100" > raw_issues.json
          
          # 使用 jq 处理数据（提取需要的字段，过滤掉 PR）
          # 如果你的仓库包含不需要展示的内容，可以在这里调整过滤逻辑
          cat raw_issues.json | jq '[.[] | select(.pull_request == null) | select(.title | contains("[FEEDBACK]") | not)]' > filtered_issues.json
          
          # 构建最终的 manifest 结构
          COUNT=$(cat filtered_issues.json | jq 'length')
          echo "{ \"last_updated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\", \"total\": $COUNT, \"items\": $(cat filtered_issues.json) }" > manifest.json

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add manifest.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: auto update manifest.json [skip ci]" && git push)